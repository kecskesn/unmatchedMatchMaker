<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="src/css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>

<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <a class="btn btn-primary" id="heroStatBtn" data-url="heroStat"><i class="fas fa-chart-bar"></i></a>
            <a class="btn btn-primary" id="cardTrackerBtn" data-url="cardTracker"><i class="fas fa-layer-group"></i></a>
            <a class="btn btn-primary" id="matchLoggerBtn" data-url="matchLogger"><i class="fas fa-file-alt"></i></a>
            <a class="btn btn-primary active" id="playerStatsBtn" data-url="playerStats"><i
                    class="fas fa-users"></i></a>
        </div>

        <div class="mt-4">
            <div class="row justify-content-center">
                <!-- Player cards will be dynamically generated here -->
            </div>
        </div>
    </div>

    <script>
        const heroStatBtn = document.getElementById("heroStatBtn");
        const cardTrackerBtn = document.getElementById("cardTrackerBtn");
        const matchLoggerBtn = document.getElementById("matchLoggerBtn");
        const playerStatsBtn = document.getElementById("playerStatsBtn");

        heroStatBtn.addEventListener("click", handleButtonClick);
        cardTrackerBtn.addEventListener("click", handleButtonClick);
        matchLoggerBtn.addEventListener("click", handleButtonClick);
        playerStatsBtn.addEventListener("click", handleButtonClick);

        function handleButtonClick() {
            const baseUrl = this.getAttribute("data-url");
            const urlParams = new URLSearchParams(window.location.search);
            const newUrl = `${baseUrl}?${urlParams.toString()}`;
            window.location.href = newUrl;
        }

        async function playerStatistics() {
            try {
                const response = await fetch('/playerStatistics');
                const playerStatsResult = await response.json();
                console.log(playerStatsResult);

                const container = document.querySelector(".row.justify-content-center");

                Object.entries(playerStatsResult).forEach(([playerName, playerStats]) => {
                    const playerCard = createPlayerCard(playerName, playerStats);
                    container.appendChild(playerCard);
                });

            } catch (error) {
                console.error('Error fetching player stats:', error);
            }
        }

        function createPlayerCard(playerName, playerStats) {
            const cardColumn = document.createElement("div");
            cardColumn.classList.add("col-md-4");

            const card = document.createElement("div");
            card.classList.add("card", "mb-4");

            const cardBody = document.createElement("div");
            cardBody.classList.add("card-body");

            const cardTitle = document.createElement("h5");
            cardTitle.classList.add("card-title");
            cardTitle.textContent = playerName;

            const winsParagraph = document.createElement("p");
            winsParagraph.classList.add("card-text", "mb-3");
            winsParagraph.textContent = `Plays: ${playerStats.plays} (${playerStats.wins}W/${playerStats.losses}L ${playerStats.winRate}%)`;

            const topHeroesTitle = document.createElement("div");
            topHeroesTitle.classList.add("card-subtitle", "mb-3");
            topHeroesTitle.textContent = "Top 3 Most Played Heroes";

            const topHeroesList = document.createElement("ul");
            topHeroesList.classList.add("list-group", "list-group-flush");
            playerStats.heroStats.sort((a, b) => b.plays - a.plays).slice(0, 3).forEach(hero => {
                const listItem = document.createElement("li");
                listItem.classList.add("list-group-item");
                listItem.textContent = `${hero.name} - Plays: ${hero.plays} (${hero.wins}W/${hero.losses}L ${hero.winRate}%)`;
                topHeroesList.appendChild(listItem);
            });

            const topWinRateTitle = document.createElement("div");
            topWinRateTitle.classList.add("card-subtitle", "mb-3");
            topWinRateTitle.textContent = "Top 3 Highest Win Rate Heroes";

            const topWinRateList = document.createElement("ul");
            topWinRateList.classList.add("list-group", "list-group-flush");
            playerStats.heroStats
                .filter(hero => hero.plays >= 2)
                .sort((a, b) => b.winRate - a.winRate)
                .slice(0, 3)
                .forEach(hero => {
                    const listItem = document.createElement("li");
                    listItem.classList.add("list-group-item");
                    listItem.textContent = `${hero.name} - Plays: ${hero.plays} (${hero.wins}W/${hero.losses}L ${hero.winRate}%)`;
                    topWinRateList.appendChild(listItem);
                });

            const worstWinRateTitle = document.createElement("div");
            worstWinRateTitle.classList.add("card-subtitle", "mb-3");
            worstWinRateTitle.textContent = "Worst Win Rate Hero";

            const worstWinRateList = document.createElement("ul");
            worstWinRateList.classList.add("list-group", "list-group-flush");
            const worstHero = playerStats.heroStats.filter(hero => hero.plays >= 2).reduce((prev, curr) => prev.winRate < curr.winRate ? prev : curr, { winRate: Infinity });
            const worstWinRateItem = document.createElement("li");
            worstWinRateItem.classList.add("list-group-item");
            worstWinRateItem.textContent = `${worstHero.name} - Plays: ${worstHero.plays} (${worstHero.wins}W/${worstHero.losses}L ${worstHero.winRate}%)`;
            worstWinRateList.appendChild(worstWinRateItem);

            cardBody.appendChild(cardTitle);
            cardBody.appendChild(winsParagraph);
            cardBody.appendChild(topHeroesTitle);
            cardBody.appendChild(topHeroesList);
            cardBody.appendChild(topWinRateTitle);
            cardBody.appendChild(topWinRateList);
            cardBody.appendChild(worstWinRateTitle);
            cardBody.appendChild(worstWinRateList);

            card.appendChild(cardBody);
            cardColumn.appendChild(card);

            return cardColumn;
        }

        window.onload = function () {
            playerStatistics();
        };
    </script>
</body>

</html>